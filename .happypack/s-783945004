'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _jsx = function () { var REACT_ELEMENT_TYPE = typeof Symbol === "function" && Symbol.for && Symbol.for("react.element") || 0xeac7; return function createRawReactElement(type, props, key, children) { var defaultProps = type && type.defaultProps; var childrenLength = arguments.length - 3; if (!props && childrenLength !== 0) { props = {}; } if (props && defaultProps) { for (var propName in defaultProps) { if (props[propName] === void 0) { props[propName] = defaultProps[propName]; } } } else if (!props) { props = defaultProps || {}; } if (childrenLength === 1) { props.children = children; } else if (childrenLength > 1) { var childArray = Array(childrenLength); for (var i = 0; i < childrenLength; i++) { childArray[i] = arguments[i + 3]; } props.children = childArray; } return { $$typeof: REACT_ELEMENT_TYPE, type: type, key: key === undefined ? null : '' + key, ref: null, props: props, _owner: null }; }; }(); /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This module is responsible for generating the HTML page response for
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * the react application middleware.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          */

/* eslint-disable react/no-danger */
/* eslint-disable react/no-array-index-key */

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _serializeJavascript = require('serialize-javascript');

var _serializeJavascript2 = _interopRequireDefault(_serializeJavascript);

var _config = require('../../../config');

var _config2 = _interopRequireDefault(_config);

var _ifElse = require('../../../shared/utils/logic/ifElse');

var _ifElse2 = _interopRequireDefault(_ifElse);

var _removeNil = require('../../../shared/utils/arrays/removeNil');

var _removeNil2 = _interopRequireDefault(_removeNil);

var _getClientBundleEntryAssets = require('./getClientBundleEntryAssets');

var _getClientBundleEntryAssets2 = _interopRequireDefault(_getClientBundleEntryAssets);

var _ClientConfig = require('../../../config/components/ClientConfig');

var _ClientConfig2 = _interopRequireDefault(_ClientConfig);

var _HTML = require('../../../shared/components/HTML');

var _HTML2 = _interopRequireDefault(_HTML);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// PRIVATES

function KeyedComponent({ children }) {
  return _react.Children.only(children);
}

// Resolve the assets (js/css) for the client bundle's entry chunk.
const clientEntryAssets = (0, _getClientBundleEntryAssets2.default)();

function stylesheetTag(stylesheetFilePath) {
  return _jsx('link', {
    href: stylesheetFilePath,
    media: 'screen, projection',
    rel: 'stylesheet',
    type: 'text/css'
  });
}

function scriptTag(jsFilePath) {
  return _jsx('script', {
    type: 'text/javascript',
    src: jsFilePath
  });
}

// COMPONENT

function ServerHTML(props) {
  const {
    asyncComponentsState,
    helmet,
    jobsState,
    nonce,
    reactAppString,
    routerState,
    storeState
  } = props;

  // Creates an inline script definition that is protected by the nonce.
  const inlineScript = body => _jsx('script', {
    nonce: nonce,
    type: 'text/javascript',
    dangerouslySetInnerHTML: { __html: body }
  });

  const headerElements = (0, _removeNil2.default)([...(0, _ifElse2.default)(helmet)(() => helmet.title.toComponent(), []), ...(0, _ifElse2.default)(helmet)(() => helmet.base.toComponent(), []), ...(0, _ifElse2.default)(helmet)(() => helmet.meta.toComponent(), []), ...(0, _ifElse2.default)(helmet)(() => helmet.link.toComponent(), []), (0, _ifElse2.default)(clientEntryAssets && clientEntryAssets.css)(() => stylesheetTag(clientEntryAssets.css)), ...(0, _ifElse2.default)(helmet)(() => helmet.style.toComponent(), [])]);

  const bodyElements = (0, _removeNil2.default)([
  // Bind our redux store state so the client knows how to hydrate his one
  (0, _ifElse2.default)(storeState)(() => inlineScript(`window.__APP_STATE__=${(0, _serializeJavascript2.default)(storeState)};`)),

  // Binds the client configuration object to the window object so
  // that we can safely expose some configuration values to the
  // client bundle that gets executed in the browser.
  _jsx(_ClientConfig2.default, {
    nonce: nonce
  }),

  // Bind our async components state so the client knows which ones
  // to initialise so that the checksum matches the server response.
  // @see https://github.com/ctrlplusb/react-async-component
  (0, _ifElse2.default)(asyncComponentsState)(() => inlineScript(`window.__ASYNC_COMPONENTS_REHYDRATE_STATE__=${(0, _serializeJavascript2.default)(asyncComponentsState)};`)), (0, _ifElse2.default)(jobsState)(() => inlineScript(`window.__JOBS_STATE__=${(0, _serializeJavascript2.default)(jobsState)}`)), (0, _ifElse2.default)(routerState)(() => inlineScript(`window.__ROUTER_STATE__=${(0, _serializeJavascript2.default)(routerState)}`)),

  // Enable the polyfill io script?
  // This can't be configured within a react-helmet component as we
  // may need the polyfill's before our client JS gets parsed.
  (0, _ifElse2.default)((0, _config2.default)('polyfillIO.enabled'))(() => scriptTag(`${(0, _config2.default)('polyfillIO.url')}?features=${(0, _config2.default)('polyfillIO.features').join(',')}`)),
  // When we are in development mode our development server will
  // generate a vendor DLL in order to dramatically reduce our
  // compilation times.  Therefore we need to inject the path to the
  // vendor dll bundle below.
  (0, _ifElse2.default)(process.env.BUILD_FLAG_IS_DEV === 'true' && (0, _config2.default)('bundles.client.devVendorDLL.enabled'))(() => scriptTag(`${(0, _config2.default)('bundles.client.webPath')}${(0, _config2.default)('bundles.client.devVendorDLL.name')}.js?t=${Date.now()}`)), (0, _ifElse2.default)(clientEntryAssets && clientEntryAssets.js)(() => scriptTag(clientEntryAssets.js)), ...(0, _ifElse2.default)(helmet)(() => helmet.script.toComponent(), [])]);

  return _jsx(_HTML2.default, {
    htmlAttributes: (0, _ifElse2.default)(helmet)(() => helmet.htmlAttributes.toComponent(), null),
    headerElements: headerElements.map((x, idx) => _jsx(KeyedComponent, {}, idx, x)),
    bodyElements: bodyElements.map((x, idx) => _jsx(KeyedComponent, {}, idx, x)),
    appBodyString: reactAppString
  });
}

ServerHTML.propTypes = {
  // eslint-disable-next-line react/forbid-prop-types
  asyncComponentsState: _propTypes2.default.object,
  // eslint-disable-next-line react/forbid-prop-types
  helmet: _propTypes2.default.object,
  // eslint-disable-next-line react/forbid-prop-types
  jobsState: _propTypes2.default.object,
  nonce: _propTypes2.default.string,
  reactAppString: _propTypes2.default.string,
  // eslint-disable-next-line react/forbid-prop-types
  routerState: _propTypes2.default.object,
  // eslint-disable-next-line react/forbid-prop-types
  storeState: _propTypes2.default.object
};

// EXPORT

exports.default = ServerHTML;